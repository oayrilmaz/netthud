<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Net Thud — Goal Intelligence</title>
  <meta name="description" content="Net Thud tracks decisive football moments. Scores, upcoming + TV, transfers, and AI signals." />

  <style>
    :root{
      --bg:#0b0d10;
      --card:#141821;
      --text:#eaeef3;
      --muted:#9aa3ad;
      --accent:#78ff6a;
      --warn:#ffd166;
      --border:rgba(255,255,255,.08);
      --radius:16px;
      --container:1100px;
      --headerH:64px;
      --tabsH:66px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--container);margin:0 auto;padding:24px}

    /* Header */
    header{
      border-bottom:1px solid var(--border);
      background:#0f1218;
      position:sticky;top:0;z-index:30;
    }
    .nav{
      display:flex;justify-content:space-between;align-items:center;
      height:var(--headerH);gap:12px
    }
    .brandWrap{display:flex;flex-direction:column;gap:2px}
    .brand{
      font-weight:950;letter-spacing:.06em;font-size:15px;
      display:flex;align-items:center;gap:10px;text-transform:uppercase;
    }
    .brandMark{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(120,255,106,.35);
    }
    .subtitle{font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:#0f131b;font-size:12px;color:var(--muted);
      cursor:pointer
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent)}

    /* Main */
    main{
      height:calc(100vh - var(--headerH));
      overflow:auto;
      padding:18px 0 24px;
    }

    h1{font-size:42px;margin:0 0 12px}
    p.lead{color:var(--muted);max-width:70ch;line-height:1.7}

    .disclaimer{
      margin-top:12px;font-size:12px;color:var(--muted);
      line-height:1.5;border:1px solid var(--border);
      background:#0f1218;padding:10px 12px;border-radius:12px;
    }

    /* Tabs */
    .tabsBar{
      position:sticky;top:var(--headerH);
      z-index:25;
      background:rgba(11,13,16,.92);
      border-bottom:1px solid var(--border);
      padding:12px 0;
    }
    .tabsRow{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:0 24px;max-width:var(--container);margin:0 auto;
    }
    .tabBtn{
      padding:10px 14px;border-radius:12px;
      border:1px solid var(--border);
      background:#0f131b;font-weight:900;font-size:13px;
      cursor:pointer;
    }
    .tabBtn.active{
      border-color:rgba(120,255,106,.55);
      box-shadow:0 0 12px rgba(120,255,106,.15);
    }

    /* Sections */
    .stack{
      display:grid;gap:18px;
      padding:18px 24px 0;
      max-width:var(--container);margin:0 auto;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
    }
    .boxHead{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background:#0f1218;margin-bottom:12px;
    }
    .boxHead .title{
      font-size:12px;letter-spacing:.14em;
      text-transform:uppercase;font-weight:900
    }
    .boxHead .hint{font-size:12px;color:var(--muted)}

    .list{
      display:grid;gap:12px;
      max-height:min(62vh,560px);
      overflow:auto;padding-right:6px;
    }

    .item{
      display:flex;justify-content:space-between;gap:16px;
      padding:14px;border-radius:12px;
      background:#0f131b;border:1px solid var(--border)
    }
    .item strong{font-size:15px}
    .item p{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .tag{
      font-size:11px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(120,255,106,.3);
      color:var(--accent);
      white-space:nowrap
    }

    footer{
      border-top:1px solid var(--border);
      padding:14px 0;
      font-size:12px;color:var(--muted);
      text-align:center
    }

    .tabSection{display:none}
    .tabSection.active{display:block}
  </style>
</head>

<body>

<header>
  <div class="container nav">
    <div class="brandWrap">
      <div class="brand"><span class="brandMark"></span>NET THUD</div>
      <div class="subtitle">Goal Intelligence</div>
    </div>
    <div class="right">
      <div class="pill"><span class="dot"></span>Sound: ON</div>
      <a class="pill" href="https://x.com/netthudpro" target="_blank">@netthudpro</a>
    </div>
  </div>
</header>

<main>

  <div class="container">
    <section>
      <h1>At the moment it matters.</h1>
      <p class="lead">
        Net Thud focuses on decisive outcomes and match context.
        Scores, upcoming fixtures + TV, transfers and AI-driven signals.
      </p>

      <div class="disclaimer">
        <strong>Note:</strong> NetThud uses automated pipelines (including AI).
        Data may be delayed or incomplete. Always verify with official sources.
      </div>
    </section>
  </div>

  <div class="tabsBar">
    <div class="tabsRow">
      <div class="tabBtn active" data-tab="liveScores">Live scores</div>
      <div class="tabBtn" data-tab="upcoming">Upcoming + TV</div>
      <div class="tabBtn" data-tab="finalScores">Final scores</div>
      <div class="tabBtn" data-tab="transferSignals">Transfer signals</div>
      <div class="tabBtn" data-tab="aiNews">AI news</div>
      <div class="tabBtn" data-tab="leagues">Leagues</div>
    </div>
  </div>

  <div class="stack">

    <section id="liveScores" class="tabSection active">
      <div class="card">
        <div class="boxHead">
          <div class="title">Live Scores</div>
          <div class="hint" id="liveMeta">Loading…</div>
        </div>
        <div id="liveList" class="list"></div>
      </div>
    </section>

    <section id="upcoming" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Upcoming + TV</div>
          <div class="hint" id="upcomingMeta">Loading…</div>
        </div>
        <div id="upcomingList" class="list"></div>
      </div>
    </section>

    <section id="finalScores" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Final Scores</div>
          <div class="hint" id="scoresMeta">Loading…</div>
        </div>
        <div id="scoresList" class="list"></div>
      </div>
    </section>

    <section id="transferSignals" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Transfer Signals</div>
          <div class="hint" id="transfersMeta">Loading…</div>
        </div>
        <div id="transfersList" class="list"></div>
      </div>
    </section>

    <section id="aiNews" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">AI News</div>
          <div class="hint" id="newsMeta">Loading…</div>
        </div>
        <div id="newsList" class="list"></div>
      </div>
    </section>

    <section id="leagues" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Leagues</div>
          <div class="hint" id="leaguesMeta">Loading…</div>
        </div>
        <div id="leagueChips"></div>
      </div>
    </section>

  </div>

  <footer>
    © <span id="year"></span> Net Thud • Goal Intelligence
  </footer>

</main>

<!-- ===== END OF PART 1 / 3 ===== -->
<!-- =========================
     INDEX.HTML — PART 2 / 3
     Append this directly after PART 1
========================= -->

<!-- Modal (kept here so JS in Part 3 can bind to it reliably) -->
<div class="modalOverlay" id="modalOverlay" aria-hidden="true" style="position:fixed;inset:0;background:rgba(0,0,0,.68);display:none;z-index:60;padding:18px;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="width:min(920px,100%);background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;">
    <div class="modalHeader" style="display:flex;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);background:#0f1218;position:sticky;top:0;">
      <div>
        <div class="modalTitle" id="modalTitle" style="font-weight:900">Details</div>
        <div class="modalMeta" id="modalMeta" style="font-size:12px;color:var(--muted);margin-top:4px"></div>
      </div>
      <button class="closeBtn" id="modalClose" style="padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f131b;font-weight:900;cursor:pointer;color:var(--text)">Close</button>
    </div>
    <div class="modalBody" style="padding:16px">
      <div class="modalActions" id="modalActions" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"></div>
      <div class="modalContent" id="modalContent" style="margin-top:14px;line-height:1.7;color:var(--text);font-size:14px;white-space:pre-wrap"></div>

      <div class="subBox" id="modalKVBox" style="display:none;border:1px solid var(--border);background:#0f131b;border-radius:14px;padding:12px;margin-top:12px;">
        <div class="subBoxTitle" style="font-weight:900;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 8px;">Snapshot</div>
        <div class="kv" id="modalKV" style="display:grid;grid-template-columns:140px 1fr;gap:8px 12px;font-size:13px"></div>
      </div>

      <div class="subBox" id="modalLegalBox" style="border:1px solid var(--border);background:#0f131b;border-radius:14px;padding:12px;margin-top:12px;">
        <div class="subBoxTitle" style="font-weight:900;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 8px;">Disclosure</div>
        <div class="modalContent" style="margin-top:0;color:var(--muted);white-space:pre-wrap">
          This view is generated automatically and may contain errors. It is not official match or transfer confirmation.
          Verify with primary sources (club statements, league data, official competition feeds).
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ---------------------------
     PATHS
  --------------------------- */
  const PATHS = {
    scores:   "/assets/data/scores.json",
    upcoming: "/assets/data/upcoming.json",
    transfers:"/assets/data/transfers.json",
    news:     "/assets/data/ai-news.json",
    leagues:  "/assets/data/leagues.json",

    // NEW: optional TV directory you can generate later (recommended)
    // Shape: { updated:"...", items:[ { matchId:123, tv:["Paramount+","CBS Sports Network"] } ] }
    tv:       "/assets/data/tv.json"
  };

  /* ---------------------------
     Small helpers
  --------------------------- */
  const $ = (id) => document.getElementById(id);
  function safeEl(id){ return document.getElementById(id); }
  function safeSetText(id, text){ const el = safeEl(id); if (el) el.textContent = text; }

  window.addEventListener("error", (e)=>console.error("NetThud JS Error:", e.message, e.filename, e.lineno));
  window.addEventListener("unhandledrejection", (e)=>console.error("NetThud Promise Error:", e.reason));

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  // Cache-bust hard so GitHub Pages updates show quickly
  async function readJson(url) {
    const u = new URL(url, window.location.origin);
    u.searchParams.set("v", Date.now());
    const res = await fetch(u.toString(), { cache:"no-store" });
    if (!res.ok) throw new Error(`Missing: ${url} (HTTP ${res.status})`);
    return res.json();
  }

  function isLiveStatus(s){
    const st = String(s || "").toUpperCase();
    return st === "LIVE" || st === "HT" || st === "IN_PLAY" || st === "PAUSED";
  }
  function isFinalStatus(s){
    const st = String(s || "").toUpperCase();
    return st === "FT" || st === "FINISHED";
  }

  function makeBtn(label, onClick, secondary=false){
    const b = document.createElement("div");
    b.className = "mini" + (secondary ? " secondary" : "");
    b.textContent = label;
    b.addEventListener("click", (e)=>{ e.stopPropagation(); onClick(); });
    return b;
  }
  function pageUrlNoHash(){
    const u = new URL(window.location.href);
    u.hash = "";
    return u.toString();
  }
  function shareUrl(hash){
    return pageUrlNoHash() + "#" + hash;
  }
  function shareToX(text, url){
    const u = new URL("https://twitter.com/intent/tweet");
    u.searchParams.set("text", text);
    u.searchParams.set("url", url);
    window.open(u.toString(), "_blank", "noopener");
  }
  async function copyLink(text){
    try{
      await navigator.clipboard.writeText(text);
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch{}
      document.body.removeChild(ta);
    }
  }

  function rowBasic(title, meta, tagText, tagClass="") {
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <div style="min-width:0">
        <strong>${esc(title)}</strong>
        <p>${esc(meta || "")}</p>
      </div>
      <span class="tag ${esc(tagClass)}">${esc(tagText || "")}</span>
    `;
    return d;
  }

  function emptyState(container, title, meta) {
    container.innerHTML = "";
    container.appendChild(rowBasic(title, meta, "EMPTY", "warn"));
  }

  /* ---------------------------
     Highlights helpers
  --------------------------- */
  function ytHighlightsUrl(home, away){
    const q = encodeURIComponent(`${home} vs ${away} highlights`);
    return `https://www.youtube.com/results?search_query=${q}`;
  }
  function openHighlights(item){
    const direct = String(item.highlightsUrl || "").trim();
    const url = direct || ytHighlightsUrl(item.home || "Home", item.away || "Away");
    window.open(url, "_blank", "noopener");
  }

  /* ---------------------------
     Clickable row w/ actions
  --------------------------- */
  function rowClickable({ title, meta, tagText, tagClass="", hash, onOpenDetails, extraButtons=[] }) {
    const wrap = document.createElement("div");
    wrap.className = "item";
    wrap.style.cursor = "pointer";

    const left = document.createElement("div");
    left.style.minWidth = "0";
    left.innerHTML = `
      <strong>${esc(title)}</strong>
      <p>${esc(meta || "")}</p>
      <div class="rowActions"></div>
    `;

    const actions = left.querySelector(".rowActions");
    const u = shareUrl(hash);

    actions.appendChild(makeBtn("Details", ()=>{
      history.replaceState(null,"",u);
      onOpenDetails();
    }));

    extraButtons.forEach(btn => actions.appendChild(btn));

    actions.appendChild(makeBtn("Share X", ()=>shareToX(title + " — NetThud", u)));
    actions.appendChild(makeBtn("Copy link", ()=>copyLink(u), true));

    const right = document.createElement("span");
    right.className = "tag " + (tagClass || "");
    right.textContent = tagText || "";

    wrap.appendChild(left);
    wrap.appendChild(right);

    wrap.addEventListener("click", (e)=>{
      if (e.target && e.target.classList && e.target.classList.contains("mini")) return;
      history.replaceState(null,"",u);
      onOpenDetails();
    });

    return wrap;
  }

  /* ---------------------------
     Modal
  --------------------------- */
  function openModal(payload){
    const overlay = $("modalOverlay");
    const titleEl = $("modalTitle");
    const metaEl = $("modalMeta");
    const contentEl = $("modalContent");
    const actionsEl = $("modalActions");
    const closeBtn = $("modalClose");

    const kvBox = $("modalKVBox");
    const kv = $("modalKV");

    titleEl.textContent = payload.title || "Details";
    metaEl.textContent = payload.meta || "";
    contentEl.textContent = payload.article || "";

    if (payload.kv && typeof payload.kv === "object") {
      kvBox.style.display = "";
      kv.innerHTML = "";
      Object.entries(payload.kv).forEach(([k,v])=>{
        const kEl = document.createElement("div");
        kEl.style.color = "var(--muted)";
        kEl.textContent = k;

        const vEl = document.createElement("div");
        vEl.innerHTML = "<strong style='color:var(--text)'>" + esc(String(v ?? "")) + "</strong>";

        kv.appendChild(kEl);
        kv.appendChild(vEl);
      });
    } else {
      kvBox.style.display = "none";
      kv.innerHTML = "";
    }

    actionsEl.innerHTML = "";
    if (payload.shareUrl) {
      actionsEl.appendChild(makeBtn("Share X", ()=>shareToX(payload.shareText || payload.title || "NetThud", payload.shareUrl)));
      actionsEl.appendChild(makeBtn("Copy link", ()=>copyLink(payload.shareUrl), true));
    }
    if (payload.highlightsUrl) {
      actionsEl.appendChild(makeBtn("Highlights", ()=>window.open(payload.highlightsUrl, "_blank", "noopener")));
    }
    actionsEl.appendChild(makeBtn("Home", ()=>{
      history.replaceState(null,"",pageUrlNoHash());
      close();
    }, true));

    overlay.style.display = "flex";
    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden","false");

    function close(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden","true");
      overlay.style.display = "none";
      window.removeEventListener("keydown", onKey);
      overlay.removeEventListener("click", onBg);
      closeBtn.removeEventListener("click", close);
    }
    function onKey(e){ if(e.key==="Escape") close(); }
    function onBg(e){ if(e.target===overlay) close(); }

    window.addEventListener("keydown", onKey);
    overlay.addEventListener("click", onBg);
    closeBtn.addEventListener("click", close);
  }

  function buildMatchDetails({ kind, item }) {
    const league = item.league || "";
    const when = item.when || item.kickoffLocal || item.kickoffUTC || "";
    const home = item.home || "";
    const away = item.away || "";
    const score = item.score || "";
    const status = (item.status || "").toUpperCase();

    const title =
      kind === "upcoming"
        ? `${home} vs ${away}`
        : `${home} ${score ? score : ""} ${away}`.trim();

    const lines = [];
    lines.push(title);
    lines.push("");
    lines.push("AI Match Notes");
    lines.push("- Context is auto-generated from public match data + lightweight heuristics.");
    lines.push("- Treat as guidance, not official reporting.");
    lines.push("");
    lines.push("What to watch");
    if (kind === "upcoming") {
      lines.push("- Check official lineups ~60 minutes before kickoff.");
      lines.push("- Confirm broadcast locally (it can vary by country/provider).");
    } else if (kind === "live") {
      lines.push("- Live state can lag: confirm time, cards, xG via primary feeds.");
    } else {
      lines.push("- Review key turning points: first goal timing, cards, substitutions.");
    }
    lines.push("");
    lines.push("Disclaimer");
    lines.push("This content is AI-generated and may contain errors or omissions.");

    const meta = [league, when].filter(Boolean).join(" • ");

    const kv = {
      League: league || "—",
      When: when || "—",
      Status: status || "—",
      Score: score || "—"
    };

    const highlightsUrl = String(item.highlightsUrl || "").trim() || ytHighlightsUrl(home, away);

    return { title, meta, article: lines.join("\n"), kv, highlightsUrl };
  }

  function buildSignalDetails({ item }) {
    const title = item.title || "Transfer signal";
    const stage = String(item.stage || "watch").toUpperCase();
    const conf = (item.confidence == null) ? "—" : Math.round(Number(item.confidence)*100) + "%";
    const source = item.source || "NetThud Signals";
    const publishedAt = item.publishedAt ? String(item.publishedAt).slice(0,19) : "";

    const lines = [];
    lines.push(title);
    lines.push("");
    lines.push("AI Signal Summary");
    lines.push(`- Stage: ${stage}`);
    lines.push(`- Confidence: ${conf}`);
    lines.push("");
    lines.push("Disclaimer");
    lines.push("Signals are probabilistic, AI-generated, and not confirmation of a transfer.");

    const meta = [source, publishedAt].filter(Boolean).join(" • ");
    const kv = { Stage: stage, Confidence: conf, Source: source, Time: publishedAt || "—" };
    return { title, meta, article: lines.join("\n"), kv };
  }

  /* ---------------------------
     TV MAPPING (Upcoming + TV fix)
     Goal:
      - Show local channels if g.tv exists
      - If g.tv empty, try tv.json keyed by matchId
      - If still empty: show “TV: TBA”
  --------------------------- */
  function normalizeTvList(tv){
    if (!tv) return [];
    if (Array.isArray(tv)) return tv.map(x=>String(x||"").trim()).filter(Boolean);
    if (typeof tv === "string") return tv.split(",").map(x=>x.trim()).filter(Boolean);
    return [];
  }

  function buildTvIndex(tvPayload){
    // tvPayload shape: { items:[ { matchId, tv:[...] } ] } OR { [matchId]: [...] }
    const idx = new Map();
    if (!tvPayload) return idx;

    if (Array.isArray(tvPayload.items)) {
      for (const it of tvPayload.items) {
        const id = it && (it.matchId ?? it.id);
        if (id == null) continue;
        const list = normalizeTvList(it.tv);
        if (list.length) idx.set(String(id), list);
      }
      return idx;
    }

    if (typeof tvPayload === "object") {
      for (const [k,v] of Object.entries(tvPayload)) {
        const list = normalizeTvList(v);
        if (list.length) idx.set(String(k), list);
      }
    }
    return idx;
  }

  function tvLineForMatch(match, tvIndex){
    const direct = normalizeTvList(match.tv);
    if (direct.length) return direct;

    const id = match.matchId ?? match.id;
    if (id != null) {
      const hit = tvIndex.get(String(id));
      if (hit && hit.length) return hit;
    }
    return [];
  }

  /* ---------------------------
     Index arrays (used for modal routing in Part 3)
  --------------------------- */
  let LIVE_INDEX = [];
  let FINAL_INDEX = [];
  let UPCOMING_INDEX = [];
  let SIGNALS_INDEX = [];
  let NEWS_INDEX = [];

  /* ---------------------------
     Loaders (Scores + Upcoming only in Part 2)
     - Transfers/News/Leagues + routing + tabs wiring in Part 3
  --------------------------- */
  async function loadScores() {
    const finalList = $("scoresList");
    const liveList  = $("liveList");

    try {
      const data = await readJson(PATHS.scores);
      const items = Array.isArray(data.items) ? data.items : [];

      const live = items.filter(m => isLiveStatus(m.status));
      const finals = items.filter(m => isFinalStatus(m.status));

      LIVE_INDEX = live;
      FINAL_INDEX = finals;

      // IMPORTANT: your generator uses "updated"
      safeSetText("liveMeta",  `${live.length} • updated ${data.updated || data.generatedAt || "—"}`);
      safeSetText("scoresMeta",`${finals.length} • updated ${data.updated || data.generatedAt || "—"}`);

      liveList.innerHTML = "";
      if (!live.length) emptyState(liveList, "No live matches right now", "Live matches will appear here.");
      else live.slice(0,40).forEach((m, i) => {
        const title = `${m.home || ""} ${m.score || ""} ${m.away || ""}`.trim();
        const metaLine = `${m.league || ""}${m.when ? " • " + m.when : ""}`;
        const tag = (String(m.status||"").toUpperCase()==="HT") ? "HT" : "LIVE";
        const hash = `d=live-${i}`;

        const highlightsBtn = makeBtn("Highlights", ()=>openHighlights(m), true);

        liveList.appendChild(
          rowClickable({
            title,
            meta: metaLine,
            tagText: tag,
            tagClass: "live",
            hash,
            extraButtons:[highlightsBtn],
            onOpenDetails: () => {
              const payload = buildMatchDetails({ kind:"live", item: m });
              openModal({
                ...payload,
                shareUrl: shareUrl(hash),
                shareText: title + " — NetThud"
              });
            }
          })
        );
      });

      finalList.innerHTML = "";
      if (!finals.length) emptyState(finalList, "No final scores yet", "Finished matches will appear here.");
      else finals.slice(0,60).forEach((m, i) => {
        const title = `${m.home || ""} ${m.score || ""} ${m.away || ""}`.trim();
        const metaLine = `${m.league || ""}${m.when ? " • " + m.when : ""}`;
        const hash = `d=final-${i}`;

        const highlightsBtn = makeBtn("Highlights", ()=>openHighlights(m), true);

        finalList.appendChild(
          rowClickable({
            title,
            meta: metaLine,
            tagText: "FT",
            tagClass: "",
            hash,
            extraButtons:[highlightsBtn],
            onOpenDetails: () => {
              const payload = buildMatchDetails({ kind:"final", item: m });
              openModal({
                ...payload,
                shareUrl: shareUrl(hash),
                shareText: title + " — NetThud"
              });
            }
          })
        );
      });

    } catch (e) {
      safeSetText("liveMeta","error");
      safeSetText("scoresMeta","error");
      if (liveList) {
        liveList.innerHTML = "";
        liveList.appendChild(rowBasic("Live scores not loading", e.message, "ERR", "warn"));
      }
      if (finalList) {
        finalList.innerHTML = "";
        finalList.appendChild(rowBasic("Final scores not loading", e.message, "ERR", "warn"));
      }
      console.error(e);
    }
  }

  async function loadUpcoming() {
    const list = $("upcomingList");

    // TV fallback index (tv.json)
    let tvIndex = new Map();
    try{
      const tvPayload = await readJson(PATHS.tv);
      tvIndex = buildTvIndex(tvPayload);
    }catch{
      tvIndex = new Map(); // ok if missing
    }

    try {
      const data = await readJson(PATHS.upcoming);
      const items = Array.isArray(data.items) ? data.items : [];
      UPCOMING_INDEX = items;

      safeSetText("upcomingMeta", `${items.length} • updated ${data.generatedAt || data.updated || "—"}`);

      list.innerHTML = "";
      if (!items.length) return emptyState(list, "No upcoming games yet", "Populate /assets/data/upcoming.json");

      items.slice(0,60).forEach((g, i) => {
        // ✅ TV line fix:
        const tvList = tvLineForMatch(g, tvIndex);
        const tvText = tvList.length ? ("TV: " + tvList.join(", ")) : "TV: TBA";

        const title = `${g.home} vs ${g.away}`;
        const when = (g.kickoffLocal || g.kickoffUTC || g.when || "").trim();
        const meta = `${g.league} • ${when}${tvText ? " • " + tvText : ""}`;
        const hash = `d=upcoming-${i}`;

        const highlightsBtn = makeBtn("Highlights", ()=>openHighlights(g), true);

        list.appendChild(
          rowClickable({
            title,
            meta,
            tagText: "UP",
            tagClass: "",
            hash,
            extraButtons:[highlightsBtn],
            onOpenDetails: () => {
              const payload = buildMatchDetails({ kind:"upcoming", item: g });
              // Include TV in modal snapshot
              const tvForModal = tvList.length ? tvList.join(", ") : "TBA";
              payload.kv = payload.kv || {};
              payload.kv.TV = tvForModal;

              openModal({
                ...payload,
                shareUrl: shareUrl(hash),
                shareText: title + " — NetThud"
              });
            }
          })
        );
      });

    } catch (e) {
      safeSetText("upcomingMeta","error");
      list.innerHTML = "";
      list.appendChild(rowBasic("Upcoming not loading", e.message, "ERR", "warn"));
      console.error(e);
    }
  }

  /* ===== END OF PART 2 / 3 ===== */
</script>
<!-- =========================
     INDEX.HTML — PART 3 / 3
     Append this directly after PART 2
========================= -->

<script>
  /* ---------------------------
     Transfer Signals (kept as-is but hardened)
  --------------------------- */
  const DEFAULT_SIGNALS = [
    { stage:"advanced", title:"Midfielder: fee agreed in principle — medical pending", confidence:0.74, source:"NetThud Signals", publishedAt:new Date().toISOString(), url:"https://netthud.com/" },
    { stage:"contact",  title:"Forward: agent contact reported — shortlist narrowing", confidence:0.52, source:"NetThud Signals", publishedAt:new Date().toISOString(), url:"https://netthud.com/" },
    { stage:"watch",    title:"Young defender: loan discussions open — minutes pathway", confidence:0.46, source:"NetThud Signals", publishedAt:new Date().toISOString(), url:"https://netthud.com/" }
  ];

  function clamp01(n){
    const x = Number(n);
    if (!Number.isFinite(x)) return null;
    return Math.max(0, Math.min(1, x));
  }

  function normalizeSignals(items){
    return (items || []).map(x => {
      if (!x || typeof x !== "object") return null;

      // Native signal format
      if (x.title && (x.stage || x.confidence != null)) {
        return {
          title: String(x.title || ""),
          stage: String(x.stage || "watch"),
          confidence: clamp01(x.confidence),
          source: x.source || "NetThud Signals",
          publishedAt: x.publishedAt || x.createdAt || x.date || "",
          url: x.url || ""
        };
      }

      // Alternate formats
      if (x.player || x.from || x.to) {
        const title =
          `${x.player || "Player"}: ${x.from || "?"} → ${x.to || "?"}${x.fee ? " ("+x.fee+")" : ""}` +
          (x.status ? ` — ${x.status}` : "");
        const st = String(x.status || "").toLowerCase();
        const stage = (st === "advanced" || st === "agreement") ? "advanced"
                    : (st === "rumor" || st === "contact") ? "contact"
                    : "watch";
        const confidence = (stage === "advanced") ? 0.72 : (stage === "contact") ? 0.50 : 0.40;

        return {
          title,
          stage,
          confidence,
          source: "NetThud Signals",
          publishedAt: x.publishedAt || "",
          url: x.url || ""
        };
      }

      if (x.title) {
        const st = String(x.type || x.status || "").toLowerCase();
        const stage = (st === "news") ? "advanced" : (st === "rumor") ? "contact" : "watch";
        const confidence = (stage === "advanced") ? 0.70 : (stage === "contact") ? 0.52 : 0.42;
        return {
          title: String(x.title || ""),
          stage,
          confidence,
          source: x.source || "NetThud Signals",
          publishedAt: x.publishedAt || "",
          url: x.url || ""
        };
      }

      return null;
    }).filter(Boolean);
  }

  function confidenceLabel(c){
    const n = clamp01(c);
    if (n == null) return "—";
    return Math.round(n * 100) + "%";
  }
  function stageLabel(stage){
    const s = String(stage || "").toLowerCase();
    if (s === "advanced") return "ADV";
    if (s === "contact") return "CONTACT";
    if (s === "watch") return "WATCH";
    return s.toUpperCase() || "SIG";
  }

  async function loadTransferSignals(){
    const list = $("transfersList");
    let stamp = "—";
    let items = [];

    try{
      const data = await readJson(PATHS.transfers);
      stamp = data.generatedAt || data.updated || data.updatedAt || "—";
      items = normalizeSignals(Array.isArray(data.items) ? data.items : []);
    }catch(e){
      items = [];
      stamp = "—";
    }

    if (!items.length) items = DEFAULT_SIGNALS;
    SIGNALS_INDEX = items;

    safeSetText("transfersMeta", `${items.length} • updated ${stamp}`);

    list.innerHTML = "";
    if (!items.length) return emptyState(list, "No transfer signals yet", "Populate /assets/data/transfers.json");

    items.slice(0, 80).forEach((t, idx) => {
      const dateShort = t.publishedAt ? String(t.publishedAt).slice(0,19) : "";
      const metaLine = `${t.source || "NetThud Signals"}${dateShort ? " • " + dateShort : ""}`;

      const hash = `d=signal-${idx}`;
      const u = shareUrl(hash);

      const wrap = document.createElement("div");
      wrap.className = "item";
      wrap.style.cursor = "pointer";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.innerHTML = `
        <strong>${esc(t.title || "Transfer signal")}</strong>
        <p>${esc(metaLine)}</p>
        <div class="rowActions"></div>
      `;

      const actions = left.querySelector(".rowActions");
      actions.appendChild(makeBtn("Details", ()=>{
        history.replaceState(null,"",u);
        const payload = buildSignalDetails({ item: t });
        openModal({ ...payload, shareUrl: u, shareText: (t.title||"Transfer signal")+" — NetThud" });
      }));
      actions.appendChild(makeBtn("Share X", ()=>shareToX((t.title||"Transfer signal")+" — NetThud", u)));
      actions.appendChild(makeBtn("Copy link", ()=>copyLink(u), true));

      const right = document.createElement("div");
      right.style.display = "grid";
      right.style.gap = "8px";
      right.style.justifyItems = "end";

      const tagStage = document.createElement("span");
      tagStage.className = "tag signal";
      tagStage.textContent = stageLabel(t.stage);

      const tagConf = document.createElement("span");
      tagConf.className = "tag conf";
      tagConf.textContent = confidenceLabel(t.confidence);

      right.appendChild(tagStage);
      right.appendChild(tagConf);

      wrap.appendChild(left);
      wrap.appendChild(right);

      wrap.addEventListener("click", (e)=>{
        if (e.target && e.target.classList && e.target.classList.contains("mini")) return;
        history.replaceState(null,"",u);
        const payload = buildSignalDetails({ item: t });
        openModal({ ...payload, shareUrl: u, shareText: (t.title||"Transfer signal")+" — NetThud" });
      });

      list.appendChild(wrap);
    });
  }

  /* ---------------------------
     AI News
  --------------------------- */
  function slugify(s){
    return String(s||"")
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g,"")
      .replace(/\s+/g,"-")
      .replace(/-+/g,"-")
      .slice(0,60) || ("id-"+Math.random().toString(16).slice(2));
  }

  function buildFallbackArticle(n){
    const title = n.title || "News";
    const summary = n.summary || "";
    return [
      title,
      "",
      "Context",
      "This item is generated by NetThud AI as a fast brief + a longer read format.",
      "",
      "What happened",
      summary || "No summary provided yet.",
      "",
      "Why it matters",
      "This can influence match prep, tactics, availability, and short-term attention around fixtures.",
      "",
      "What to watch next",
      "Look for primary-source confirmation and follow-on signals over the next 24–72 hours.",
      "",
      "Disclaimer",
      "AI-generated summary; may contain errors."
    ].join("\n");
  }

  async function loadNews() {
    const list = $("newsList");
    try {
      const data = await readJson(PATHS.news);
      const items = Array.isArray(data.items) ? data.items : [];
      safeSetText("newsMeta", `${items.length} • updated ${data.generatedAt || data.updated || data.updatedAt || "—"}`);

      list.innerHTML = "";
      if (!items.length) return emptyState(list, "No news items yet", "Populate /assets/data/ai-news.json");

      NEWS_INDEX = items.map((n,i)=>{
        const id = n.id || ("news-"+(i+1));
        const slug = slugify(id);
        const title = n.title || ("News-"+(i+1));
        const source = n.source || "NetThud AI";
        const createdAt = n.createdAt || n.publishedAt || n.date || "";
        const metaLine = [source, createdAt ? String(createdAt).slice(0,19) : ""].filter(Boolean).join(" • ");
        const article = (n.article && String(n.article).trim().length > 60) ? String(n.article) : buildFallbackArticle({title, summary:n.summary});
        return { slug, title, meta: metaLine, summary: n.summary || n.short || "", article };
      });

      NEWS_INDEX.slice(0, 60).forEach((n, idx) => {
        const label = "News-" + (idx+1);
        const title = `${label} • ${n.title}`;
        const meta = n.summary || "Click to open the AI article.";
        const hash = `news=${n.slug}`;

        list.appendChild(
          rowClickable({
            title,
            meta,
            tagText: "OPEN",
            tagClass: "",
            hash,
            onOpenDetails: () => {
              const u = shareUrl(hash);
              openModal({
                title: n.title,
                meta: n.meta,
                article: n.article,
                shareUrl: u,
                shareText: n.title + " — NetThud AI"
              });
            }
          })
        );
      });

    } catch (e) {
      safeSetText("newsMeta","error");
      list.innerHTML = "";
      list.appendChild(rowBasic("AI News not loading", e.message, "ERR", "warn"));
      console.error(e);
    }
  }

  /* ---------------------------
     Leagues
  --------------------------- */
  async function loadLeagues() {
    const container = $("leagueChips");
    try {
      const data = await readJson(PATHS.leagues);
      const leagues = Array.isArray(data) ? data
                    : Array.isArray(data.items) ? data.items
                    : Array.isArray(data.leagues) ? data.leagues
                    : [];
      safeSetText("leaguesMeta", `${leagues.length} • updated ${data.updated || data.generatedAt || "—"}`);

      container.innerHTML = "";
      if (!leagues.length) {
        const empty = document.createElement("div");
        empty.className = "item";
        empty.innerHTML = `
          <div>
            <strong>No leagues yet</strong>
            <p>/assets/data/leagues.json loaded, but items[] is empty.</p>
          </div>
          <span class="tag warn">EMPTY</span>
        `;
        container.appendChild(empty);
        return;
      }

      leagues.forEach(l => {
        const el = document.createElement("div");
        el.className = "chip";

        const name = (l && typeof l === "object") ? (l.name || l.key || "League") : String(l);
        const emoji = (l && typeof l === "object") ? (l.emoji || "") : "";
        const country = (l && typeof l === "object") ? (l.country || "") : "";

        el.innerHTML = `<span class="dot"></span>${esc(emoji ? emoji + " " : "")}${esc(name)}${esc(country ? " • " + country : "")}`;
        container.appendChild(el);
      });
    } catch (e) {
      safeSetText("leaguesMeta","error");
      container.innerHTML = "";
      container.appendChild(rowBasic("Leagues not loading", e.message, "ERR", "warn"));
      console.error(e);
    }
  }

  /* ---------------------------
     Hash routing
       #t=tabId
       #news=slug
       #d=kind-index  (live/final/upcoming/signal)
  --------------------------- */
  function tryOpenFromHash(){
    const h = window.location.hash || "";

    // Tabs
    if (h.startsWith("#t=")){
      const tabId = decodeURIComponent(h.slice(3));
      if (tabId) showTab(tabId, { push:false });
      return;
    }

    // News modal
    if (h.startsWith("#news=")){
      const slug = decodeURIComponent(h.slice("#news=".length));
      const found = NEWS_INDEX.find(x => x.slug === slug);
      if (!found) return;
      const u = shareUrl("news=" + found.slug);
      openModal({
        title: found.title,
        meta: found.meta,
        article: found.article,
        shareUrl: u,
        shareText: found.title + " — NetThud AI"
      });
      return;
    }

    // Details modal
    if (!h.startsWith("#d=")) return;
    const key = decodeURIComponent(h.slice("#d=".length)); // live-3
    const [kind, idxStr] = key.split("-");
    const idx = Number(idxStr);
    if (!Number.isFinite(idx) || idx < 0) return;

    let payload = null;

    if (kind === "live" && LIVE_INDEX[idx]) payload = buildMatchDetails({ kind:"live", item: LIVE_INDEX[idx] });
    if (kind === "final" && FINAL_INDEX[idx]) payload = buildMatchDetails({ kind:"final", item: FINAL_INDEX[idx] });
    if (kind === "upcoming" && UPCOMING_INDEX[idx]) payload = buildMatchDetails({ kind:"upcoming", item: UPCOMING_INDEX[idx] });
    if (kind === "signal" && SIGNALS_INDEX[idx]) payload = buildSignalDetails({ item: SIGNALS_INDEX[idx] });

    if (!payload) return;

    const u = shareUrl("d=" + kind + "-" + idx);
    openModal({
      title: payload.title,
      meta: payload.meta,
      article: payload.article,
      kv: payload.kv,
      highlightsUrl: payload.highlightsUrl,
      shareUrl: u,
      shareText: payload.title + " — NetThud"
    });
  }

  /* ---------------------------
     Tabs logic (no scrolling to anchors)
  --------------------------- */
  function showTab(tabId, { push=true } = {}){
    document.querySelectorAll(".tabSection").forEach(s => s.classList.remove("active"));
    const target = document.getElementById(tabId);
    if (target) target.classList.add("active");

    document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
    const btn = document.querySelector(`.tabBtn[data-tab="${CSS.escape(tabId)}"]`);
    if (btn) btn.classList.add("active");

    const main = document.querySelector("main");
    if (main) main.scrollTo({ top: 0, behavior: "smooth" });

    if (push){
      history.replaceState(null, "", "#t=" + encodeURIComponent(tabId));
    }
  }

  function wireTabs() {
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.style.cursor = "pointer";

    btn.addEventListener("click", () => {
      const tabId = btn.dataset.tab;
      if (!tabId) return;

      // deactivate all
      document.querySelectorAll(".tabSection").forEach(s =>
        s.classList.remove("active")
      );
      document.querySelectorAll(".tabBtn").forEach(b =>
        b.classList.remove("active")
      );

      // activate target
      document.getElementById(tabId)?.classList.add("active");
      btn.classList.add("active");

      // update URL
      history.replaceState(null, "", "#t=" + tabId);
    });
  });
}
  /* ---------------------------
     Sound toggle
  --------------------------- */
  const SOUND_KEY = "netthud_sound";
  function setSoundUI(on){
    const st = $("soundState");
    if (st) st.textContent = on ? "ON" : "OFF";
  }
  function getSound(){ return localStorage.getItem(SOUND_KEY) !== "0"; }
  function setSound(on){ localStorage.setItem(SOUND_KEY, on ? "1" : "0"); setSoundUI(on); }
  function beep(){
    if (!getSound()) return;
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type="sine"; o.frequency.value=440; g.gain.value=0.02;
      o.connect(g); g.connect(ctx.destination);
      o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 80);
    }catch{}
  }

  /* ---------------------------
     Boot
  --------------------------- */
  document.addEventListener("DOMContentLoaded", async () => {
    const yearEl = $("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    try{
      wireTabs();

      setSoundUI(getSound());
      const sp = $("soundPill");
      if (sp) {
        sp.addEventListener("click", ()=>{
          const on = !getSound();
          setSound(on);
          beep();
        });
      }

      // Loaders
      await loadScores();
      // await loadUpcoming();   // TEMP disable
      await loadTransferSignals();
      await loadNews();
      await loadLeagues();

      // Default tab if none
      if (!window.location.hash || window.location.hash === "#"){
        showTab("liveScores", { push:false });
      } else {
        tryOpenFromHash();
      }

      window.addEventListener("hashchange", tryOpenFromHash);
    }catch(e){
      console.error("NetThud boot failed:", e);
      safeSetText("liveMeta","error");
      safeSetText("upcomingMeta","error");
      safeSetText("scoresMeta","error");
      safeSetText("transfersMeta","error");
      safeSetText("newsMeta","error");
      safeSetText("leaguesMeta","error");
    }
  });
</script>

</body>
</html>
