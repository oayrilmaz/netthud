<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Net Thud — Goal Intelligence</title>
  <meta name="description" content="Net Thud tracks decisive football moments. Scores, upcoming + TV, transfers, and AI signals." />

  <style>
    :root{
      --bg:#0b0d10;
      --card:#141821;
      --text:#eaeef3;
      --muted:#9aa3ad;
      --accent:#78ff6a;
      --warn:#ffd166;
      --border:rgba(255,255,255,.08);
      --radius:16px;
      --container:1100px;
      --headerH:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--text);
      overflow:hidden; /* page itself doesn't scroll; main scrolls */
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--container);margin:0 auto;padding:24px}

    header{
      border-bottom:1px solid var(--border);
      background:#0f1218;
      position:sticky;top:0;z-index:30;
    }
    .nav{
      display:flex;justify-content:space-between;align-items:center;
      height:var(--headerH);gap:12px
    }
    .brandWrap{display:flex;flex-direction:column;gap:2px}
    .brand{
      font-weight:950;letter-spacing:.06em;font-size:15px;
      display:flex;align-items:center;gap:10px;text-transform:uppercase;
    }
    .brandMark{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 18px rgba(120,255,106,.35);
    }
    .subtitle{font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:#0f131b;font-size:12px;color:var(--muted);
      cursor:pointer
    }
    .pill a{cursor:pointer}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);box-shadow:0 0 12px rgba(120,255,106,.35)}

    main{
      height:calc(100vh - var(--headerH));
      overflow:auto;
      padding:18px 0 24px;
    }

    h1{font-size:42px;margin:0 0 12px}
    p.lead{color:var(--muted);max-width:70ch;line-height:1.7;margin:0}

    .disclaimer{
      margin-top:12px;font-size:12px;color:var(--muted);
      line-height:1.5;border:1px solid var(--border);
      background:#0f1218;padding:10px 12px;border-radius:12px;
    }

    .tabsBar{
      position:sticky;top:var(--headerH);
      z-index:25;
      background:linear-gradient(to bottom, rgba(11,13,16,.96), rgba(11,13,16,.70));
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
      margin-top:14px;
      padding:12px 0;
    }
    .tabsRow{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:0 24px;max-width:var(--container);margin:0 auto;
    }
    .tabBtn{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:12px;
      border:1px solid var(--border);
      background:#0f131b;font-weight:900;font-size:13px;
      cursor:pointer;user-select:none;
    }
    .tabBtn.active{
      border-color:rgba(120,255,106,.55);
      box-shadow:0 0 0 1px rgba(120,255,106,.14) inset, 0 0 18px rgba(120,255,106,.08);
    }
    .tabBtn:active{transform:translateY(1px)}

    .stack{
      display:grid;gap:18px;
      padding:18px 24px 0;
      max-width:var(--container);margin:0 auto;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:14px;
      min-height:0;
    }
    .boxHead{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--border);
      background:#0f1218;margin-bottom:12px;
    }
    .boxHead .title{
      font-size:12px;letter-spacing:.14em;
      text-transform:uppercase;font-weight:900
    }
    .boxHead .hint{font-size:12px;color:var(--muted);white-space:nowrap}

    .list{
      display:grid;gap:12px;
      max-height:min(62vh,560px);
      overflow:auto;padding-right:6px;
    }

    .item{
      display:flex;justify-content:space-between;align-items:flex-start;gap:16px;
      padding:14px;border-radius:12px;
      background:#0f131b;border:1px solid var(--border)
    }
    .item strong{font-size:15px;display:block}
    .item p{margin:6px 0 0;font-size:13px;color:var(--muted);line-height:1.35}

    .tag{
      font-size:11px;font-weight:900;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(120,255,106,.3);
      color:var(--accent);
      white-space:nowrap
    }
    .tag.warn{border-color:rgba(255,209,102,.35);color:var(--warn)}
    .tag.live{border-color:rgba(120,255,106,.55);box-shadow:0 0 0 1px rgba(120,255,106,.12) inset}
    .tag.signal{border-color:rgba(120,255,106,.25);color:var(--text);background:rgba(120,255,106,.06)}
    .tag.conf{border-color:rgba(255,255,255,.12);color:var(--muted);background:rgba(255,255,255,.04)}

    .rowActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .mini{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#0b0f16;
      font-size:12px;font-weight:900;color:var(--text);
      cursor:pointer;user-select:none;
    }
    .mini.secondary{color:var(--muted)}
    .mini:active{transform:translateY(1px)}

    .chips{display:flex;flex-wrap:wrap;gap:10px;overflow:auto;max-height:220px;padding-right:6px}
    .chip{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--border);
      background:#0f131b;font-size:13px;color:var(--text)
    }
    .chip .dot{width:10px;height:10px}

    footer{
      border-top:1px solid var(--border);
      padding:14px 0;
      font-size:12px;color:var(--muted);
      text-align:center
    }

    .tabSection{display:none}
    .tabSection.active{display:block}
  </style>
</head>

<body>

<header>
  <div class="container nav">
    <div class="brandWrap">
      <div class="brand"><span class="brandMark"></span>NET THUD</div>
      <div class="subtitle">Goal Intelligence</div>
    </div>
    <div class="right">
      <div class="pill" id="soundPill"><span class="dot"></span>Sound: <strong id="soundState">ON</strong></div>
      <a class="pill" href="https://x.com/netthudpro" target="_blank" rel="noopener">@netthudpro</a>
    </div>
  </div>
</header>

<main>

  <div class="container">
    <section>
      <h1>At the moment it matters.</h1>
      <p class="lead">
        Net Thud focuses on decisive outcomes and match context.
        Scores, upcoming fixtures + TV, transfers and AI-driven signals.
      </p>

      <div class="disclaimer" role="note">
        <strong>Note:</strong> NetThud uses automated pipelines (including AI).
        Data may be delayed or incomplete. Always verify with official sources.
      </div>
    </section>
  </div>

  <div class="tabsBar" role="navigation" aria-label="Sections">
    <div class="tabsRow" id="tabsRow">
      <div class="tabBtn active" data-tab="liveScores" id="tab_liveScores">Live scores</div>
      <div class="tabBtn" data-tab="upcoming" id="tab_upcoming">Upcoming + TV</div>
      <div class="tabBtn" data-tab="finalScores" id="tab_finalScores">Final scores</div>
      <div class="tabBtn" data-tab="transferSignals" id="tab_transferSignals">Transfer signals</div>
      <div class="tabBtn" data-tab="aiNews" id="tab_aiNews">AI news</div>
      <div class="tabBtn" data-tab="leagues" id="tab_leagues">Leagues</div>
    </div>
  </div>

  <div class="stack">

    <section id="liveScores" class="tabSection active">
      <div class="card">
        <div class="boxHead">
          <div class="title">Live Scores</div>
          <div class="hint" id="liveMeta">Loading…</div>
        </div>
        <div id="liveList" class="list"></div>
      </div>
    </section>

    <section id="upcoming" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Upcoming + TV</div>
          <div class="hint" id="upcomingMeta">Loading…</div>
        </div>
        <div id="upcomingList" class="list"></div>
      </div>
    </section>

    <section id="finalScores" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Final Scores</div>
          <div class="hint" id="scoresMeta">Loading…</div>
        </div>
        <div id="scoresList" class="list"></div>
      </div>
    </section>

    <section id="transferSignals" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Transfer Signals</div>
          <div class="hint" id="transfersMeta">Loading…</div>
        </div>
        <div id="transfersList" class="list"></div>
      </div>
    </section>

    <section id="aiNews" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">AI News</div>
          <div class="hint" id="newsMeta">Loading…</div>
        </div>
        <div id="newsList" class="list"></div>
      </div>
    </section>

    <section id="leagues" class="tabSection">
      <div class="card">
        <div class="boxHead">
          <div class="title">Leagues</div>
          <div class="hint" id="leaguesMeta">Loading…</div>
        </div>
        <div id="leagueChips" class="chips"></div>
      </div>
    </section>

  </div>

  <footer>
    © <span id="year"></span> Net Thud • Goal Intelligence
  </footer>

</main>

<!-- ===== END PART 1 / 4. APPEND PART 2 BELOW ===== -->
<!-- Modal -->
<div class="modalOverlay" id="modalOverlay" aria-hidden="true"
  style="position:fixed;inset:0;background:rgba(0,0,0,.68);display:none;z-index:60;padding:18px;">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle"
    style="width:min(920px,100%);background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;">
    <div class="modalHeader"
      style="display:flex;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border);background:#0f1218;position:sticky;top:0;">
      <div>
        <div class="modalTitle" id="modalTitle" style="font-weight:900">Details</div>
        <div class="modalMeta" id="modalMeta"
          style="font-size:12px;color:var(--muted);margin-top:4px"></div>
      </div>
      <button class="closeBtn" id="modalClose"
        style="padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:#0f131b;font-weight:900;cursor:pointer;color:var(--text)">
        Close
      </button>
    </div>

    <div class="modalBody" style="padding:16px">
      <div class="modalActions" id="modalActions"
        style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px"></div>

      <div class="modalContent" id="modalContent"
        style="margin-top:14px;line-height:1.7;color:var(--text);font-size:14px;white-space:pre-wrap"></div>

      <div class="subBox" id="modalKVBox"
        style="display:none;border:1px solid var(--border);background:#0f131b;border-radius:14px;padding:12px;margin-top:12px;">
        <div class="subBoxTitle"
          style="font-weight:900;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 8px;">
          Snapshot
        </div>
        <div class="kv" id="modalKV"
          style="display:grid;grid-template-columns:140px 1fr;gap:8px 12px;font-size:13px"></div>
      </div>

      <div class="subBox"
        style="border:1px solid var(--border);background:#0f131b;border-radius:14px;padding:12px;margin-top:12px;">
        <div class="subBoxTitle"
          style="font-weight:900;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin:0 0 8px;">
          Disclosure
        </div>
        <div style="font-size:12px;color:var(--muted);white-space:pre-wrap">
This view is generated automatically and may contain errors.
It is not official match or transfer confirmation.
Always verify with primary sources.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   PATHS
--------------------------- */
const PATHS = {
  scores:    "/assets/data/scores.json",
  upcoming:  "/assets/data/upcoming.json",
  transfers: "/assets/data/transfers.json",
  news:      "/assets/data/ai-news.json",
  leagues:   "/assets/data/leagues.json"
};

const $ = (id) => document.getElementById(id);
const safeEl = (id) => document.getElementById(id);
const safeSetText = (id, txt) => { const el = safeEl(id); if(el) el.textContent = txt; };

window.addEventListener("error", e =>
  console.error("NetThud JS Error:", e.message, e.filename, e.lineno)
);
window.addEventListener("unhandledrejection", e =>
  console.error("NetThud Promise Error:", e.reason)
);

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

async function readJson(url){
  const u = new URL(url, window.location.origin);
  u.searchParams.set("v", Date.now());
  const res = await fetch(u.toString(), { cache:"no-store" });
  if(!res.ok) throw new Error(`Missing ${url}`);
  return res.json();
}

/* Status helpers */
const isLiveStatus = s => ["LIVE","HT","IN_PLAY","PAUSED"].includes(String(s||"").toUpperCase());
const isFinalStatus = s => ["FT","FINISHED"].includes(String(s||"").toUpperCase());

function makeBtn(label, onClick, secondary=false){
  const b = document.createElement("div");
  b.className = "mini" + (secondary ? " secondary" : "");
  b.textContent = label;
  b.onclick = e => { e.stopPropagation(); onClick(); };
  return b;
}

/* Basic row */
function rowBasic(title, meta, tag, cls=""){
  const d = document.createElement("div");
  d.className = "item";
  d.innerHTML = `
    <div>
      <strong>${esc(title)}</strong>
      <p>${esc(meta||"")}</p>
    </div>
    <span class="tag ${cls}">${esc(tag)}</span>
  `;
  return d;
}

/* ---------------------------
   Share helpers (RESTORED)
--------------------------- */
function pageUrlNoHash(){
  const u = new URL(window.location.href);
  u.hash = "";
  return u.toString();
}
function shareUrl(hash){
  return pageUrlNoHash() + "#" + hash;
}
function shareToX(text, url){
  const u = new URL("https://twitter.com/intent/tweet");
  u.searchParams.set("text", text);
  u.searchParams.set("url", url);
  window.open(u.toString(), "_blank", "noopener");
}
async function copyLink(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); }catch{}
    document.body.removeChild(ta);
  }
}

/* ---------------------------
   Modal (FULL, with actions)
--------------------------- */
function openModal(payload){
  const overlay = $("modalOverlay");
  const titleEl = $("modalTitle");
  const metaEl = $("modalMeta");
  const contentEl = $("modalContent");
  const actionsEl = $("modalActions");
  const closeBtn = $("modalClose");

  const kvBox = $("modalKVBox");
  const kv = $("modalKV");

  titleEl.textContent = payload.title || "Details";
  metaEl.textContent = payload.meta || "";
  contentEl.textContent = payload.article || "";

  if (payload.kv && typeof payload.kv === "object") {
    kvBox.style.display = "";
    kv.innerHTML = "";
    Object.entries(payload.kv).forEach(([k,v])=>{
      const kEl = document.createElement("div");
      kEl.style.color = "var(--muted)";
      kEl.textContent = k;

      const vEl = document.createElement("div");
      vEl.innerHTML = "<strong style='color:var(--text)'>" + esc(String(v ?? "")) + "</strong>";

      kv.appendChild(kEl);
      kv.appendChild(vEl);
    });
  } else {
    kvBox.style.display = "none";
    kv.innerHTML = "";
  }

  actionsEl.innerHTML = "";

  // Share buttons restored (per-row uses these + hash routes)
  if (payload.shareUrl) {
    actionsEl.appendChild(makeBtn("Share X", ()=>shareToX(payload.shareText || payload.title || "NetThud", payload.shareUrl)));
    actionsEl.appendChild(makeBtn("Copy link", ()=>copyLink(payload.shareUrl), true));
  }
  if (payload.highlightsUrl) {
    actionsEl.appendChild(makeBtn("Highlights", ()=>window.open(payload.highlightsUrl, "_blank", "noopener")));
  }

  actionsEl.appendChild(makeBtn("Home", ()=>{
    history.replaceState(null,"",pageUrlNoHash());
    close();
  }, true));

  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden","false");

  function close(){
    overlay.setAttribute("aria-hidden","true");
    overlay.style.display = "none";
    window.removeEventListener("keydown", onKey);
    overlay.removeEventListener("click", onBg);
    closeBtn.removeEventListener("click", close);
  }
  function onKey(e){ if(e.key==="Escape") close(); }
  function onBg(e){ if(e.target===overlay) close(); }

  window.addEventListener("keydown", onKey);
  overlay.addEventListener("click", onBg);
  closeBtn.addEventListener("click", close);
}
</script>

<!-- ===== END PART 2 / 4. APPEND PART 3 BELOW ===== -->
<script>
/* ---------------------------
   SCORE + UPCOMING LOADERS
   + RESTORED per-row Share X / Copy link buttons
   + RESTORED hash routing ids (d=live-i / d=final-i / d=upcoming-i)
--------------------------- */

let LIVE_INDEX = [];
let FINAL_INDEX = [];
let UPCOMING_INDEX = [];
let SIGNALS_INDEX = [];
let NEWS_INDEX = [];

/* Highlights */
function ytHighlightsUrl(home, away){
  const q = encodeURIComponent(`${home} vs ${away} highlights`);
  return `https://www.youtube.com/results?search_query=${q}`;
}
function openHighlights(item){
  const direct = String(item.highlightsUrl || "").trim();
  const u = direct || ytHighlightsUrl(item.home || "Home", item.away || "Away");
  window.open(u, "_blank", "noopener");
}

/* Clickable row (WITH share + copy actions) */
function rowClickable({ title, meta, tag, cls="", hash, onOpenDetails, buttons=[] }){
  const wrap = document.createElement("div");
  wrap.className = "item";
  wrap.style.cursor = "pointer";

  const left = document.createElement("div");
  left.style.minWidth = "0";
  left.innerHTML = `
    <strong>${esc(title)}</strong>
    <p>${esc(meta||"")}</p>
    <div class="rowActions"></div>
  `;

  const acts = left.querySelector(".rowActions");

  // Custom buttons first (e.g., Highlights)
  buttons.forEach(b => acts.appendChild(b));

  // Always include row-level share controls
  const u = shareUrl(hash);
  acts.appendChild(makeBtn("Details", ()=>{
    history.replaceState(null,"",u);
    onOpenDetails();
  }));
  acts.appendChild(makeBtn("Share X", ()=>shareToX(title + " — NetThud", u)));
  acts.appendChild(makeBtn("Copy link", ()=>copyLink(u), true));

  const right = document.createElement("span");
  right.className = "tag " + cls;
  right.textContent = tag;

  wrap.append(left, right);
  wrap.onclick = e => {
    if(e.target && e.target.classList && e.target.classList.contains("mini")) return;
    history.replaceState(null,"",u);
    onOpenDetails();
  };
  return wrap;
}

/* Match details builder (keeps modal consistent) */
function buildMatchDetails(kind, item){
  const league = item.league || "—";
  const when = item.when || item.kickoffLocal || item.kickoffUTC || item.utcDate || "—";
  const home = item.home || item.homeTeam || item.home_name || "Home";
  const away = item.away || item.awayTeam || item.away_name || "Away";
  const score = item.score || "";

  const title = (kind === "upcoming")
    ? `${home} vs ${away}`
    : `${home} ${score ? score : ""} ${away}`.trim();

  const kv = {
    League: league,
    When: when,
    Status: String(item.status || (kind === "upcoming" ? "UP" : "—")).toUpperCase(),
    Score: score || "—"
  };

  const article = [
    title,
    "",
    "AI Match Notes",
    "- This is auto-generated from public match data + lightweight heuristics.",
    "- Treat as guidance, not official reporting.",
    "",
    "What to watch",
    kind === "upcoming"
      ? "- Confirm lineups ~60 minutes before kickoff.\n- Verify broadcaster by region."
      : (kind === "live"
          ? "- Live state can lag: verify time/cards via primary feeds."
          : "- Review turning points: first goal timing, cards, substitutions."),
    "",
    "Disclaimer",
    "AI-generated; may contain errors or omissions."
  ].join("\n");

  const highlightsUrl = String(item.highlightsUrl || "").trim() || ytHighlightsUrl(home, away);

  return { title, meta: league + " • " + when, article, kv, highlightsUrl };
}

/* -------- SCORES -------- */
async function loadScores(){
  const liveList = $("liveList");
  const finalList = $("scoresList");

  try{
    const data = await readJson(PATHS.scores);
    const items = Array.isArray(data.items) ? data.items : [];

    LIVE_INDEX = items.filter(m => isLiveStatus(m.status));
    FINAL_INDEX = items.filter(m => isFinalStatus(m.status));

    safeSetText("liveMeta", `${LIVE_INDEX.length} • updated ${data.updated || data.generatedAt || "—"}`);
    safeSetText("scoresMeta", `${FINAL_INDEX.length} • updated ${data.updated || data.generatedAt || "—"}`);

    // LIVE
    liveList.innerHTML = "";
    if(!LIVE_INDEX.length){
      liveList.appendChild(rowBasic("No live matches", "Check back soon", "—"));
    } else {
      LIVE_INDEX.slice(0,40).forEach((m, i)=>{
        const title = `${m.home || ""} ${m.score || ""} ${m.away || ""}`.trim();
        const meta  = `${m.league || "—"}${m.when ? " • " + m.when : ""}`;
        const hash  = `d=live-${i}`;

        liveList.appendChild(
          rowClickable({
            title,
            meta,
            tag: (String(m.status||"").toUpperCase()==="HT") ? "HT" : "LIVE",
            cls: "live",
            hash,
            buttons:[ makeBtn("Highlights", ()=>openHighlights(m), true) ],
            onOpenDetails: ()=>{
              const payload = buildMatchDetails("live", m);
              openModal({
                ...payload,
                shareUrl: shareUrl(hash),
                shareText: title + " — NetThud"
              });
            }
          })
        );
      });
    }

    // FINAL
    finalList.innerHTML = "";
    if(!FINAL_INDEX.length){
      finalList.appendChild(rowBasic("No final scores yet", "", "—"));
    } else {
      FINAL_INDEX
        .slice()
        .sort((a,b)=>String(b.kickoffUTC||b.when||"").localeCompare(String(a.kickoffUTC||a.when||"")))
        .slice(0,60)
        .forEach((m, i)=>{
          const title = `${m.home || ""} ${m.score || ""} ${m.away || ""}`.trim();
          const meta  = `${m.league || "—"}${m.when ? " • " + m.when : ""}`;
          const hash  = `d=final-${i}`;

          finalList.appendChild(
            rowClickable({
              title,
              meta,
              tag: "FT",
              cls: "",
              hash,
              buttons:[ makeBtn("Highlights", ()=>openHighlights(m), true) ],
              onOpenDetails: ()=>{
                const payload = buildMatchDetails("final", m);
                openModal({
                  ...payload,
                  shareUrl: shareUrl(hash),
                  shareText: title + " — NetThud"
                });
              }
            })
          );
        });
    }

  }catch(e){
    liveList.innerHTML="";
    finalList.innerHTML="";
    liveList.appendChild(rowBasic("Scores not loading", e.message, "ERR","warn"));
    finalList.appendChild(rowBasic("Scores not loading", e.message, "ERR","warn"));
  }
}

/* -------- UPCOMING -------- */
async function loadUpcoming(){
  const list = $("upcomingList");

  try{
    const data = await readJson(PATHS.upcoming);
    UPCOMING_INDEX = Array.isArray(data.items) ? data.items : [];

    safeSetText("upcomingMeta", `${UPCOMING_INDEX.length} • updated ${data.generatedAt || data.updated || "—"}`);
    list.innerHTML = "";

    if(!UPCOMING_INDEX.length){
      list.appendChild(rowBasic("No upcoming fixtures", "", "—"));
      return;
    }

    UPCOMING_INDEX.slice(0,60).forEach((g, i)=>{
      const home = g.home || g.homeTeam || g.home_name || "TBD";
      const away = g.away || g.awayTeam || g.away_name || "TBD";
      const when = g.kickoffLocal || g.kickoffUTC || g.utcDate || g.when || "";
      const tvArr = Array.isArray(g.tv) ? g.tv : (typeof g.tv === "string" ? g.tv.split(",").map(x=>x.trim()).filter(Boolean) : []);
      const tv = tvArr.length ? tvArr.join(", ") : "TBA";

      const title = `${home} vs ${away}`;
      const meta  = `${g.league || "—"} • ${when || "—"} • TV: ${tv}`;
      const hash  = `d=upcoming-${i}`;

      list.appendChild(
        rowClickable({
          title,
          meta,
          tag:"UP",
          cls:"",
          hash,
          buttons:[ makeBtn("Highlights", ()=>openHighlights({ home, away, highlightsUrl: g.highlightsUrl }), true) ],
          onOpenDetails: ()=>{
            const itemForDetails = { ...g, home, away, when };
            const payload = buildMatchDetails("upcoming", itemForDetails);
            payload.kv = payload.kv || {};
            payload.kv.TV = tv;

            openModal({
              ...payload,
              shareUrl: shareUrl(hash),
              shareText: title + " — NetThud"
            });
          }
        })
      );
    });

  }catch(e){
    list.innerHTML="";
    list.appendChild(rowBasic("Upcoming not loading", e.message, "ERR","warn"));
  }
}
</script>

<!-- ===== END PART 3 / 4. APPEND PART 4 BELOW ===== -->
<script>
/* ---------------------------
   TRANSFER SIGNALS
--------------------------- */

function clamp01(n){
  const x = Number(n);
  if (!Number.isFinite(x)) return null;
  return Math.max(0, Math.min(1, x));
}
function confidenceLabel(c){
  const n = clamp01(c);
  if (n == null) return "—";
  return Math.round(n * 100) + "%";
}
function stageLabel(stage){
  const s = String(stage || "").toLowerCase();
  if (s === "advanced") return "ADV";
  if (s === "contact") return "CONTACT";
  if (s === "watch") return "WATCH";
  return (s || "SIG").toUpperCase();
}

function buildSignalDetails(item){
  const title = item.title || "Transfer signal";
  const stage = stageLabel(item.stage);
  const conf  = confidenceLabel(item.confidence);
  const source = item.source || "NetThud Signals";
  const when = item.publishedAt ? String(item.publishedAt).slice(0,19) : "";

  const article = [
    title,
    "",
    "AI Signal Summary",
    `- Stage: ${stage}`,
    `- Confidence: ${conf}`,
    "",
    "Disclaimer",
    "Signals are probabilistic, AI-generated, and not confirmation of a transfer."
  ].join("\n");

  const meta = [source, when].filter(Boolean).join(" • ");
  const kv = { Stage: stage, Confidence: conf, Source: source, Time: when || "—" };
  return { title, meta, article, kv };
}

async function loadTransferSignals(){
  const list = $("transfersList");
  try{
    const data = await readJson(PATHS.transfers);
    SIGNALS_INDEX = Array.isArray(data.items) ? data.items : [];

    safeSetText("transfersMeta", `${SIGNALS_INDEX.length} • updated ${data.generatedAt||data.updated||"—"}`);
    list.innerHTML = "";

    if(!SIGNALS_INDEX.length){
      list.appendChild(rowBasic("No transfer signals yet", "", "—"));
      return;
    }

    SIGNALS_INDEX.slice(0,80).forEach((s, i)=>{
      const title = s.title || "Transfer signal";
      const meta = `${s.source||"NetThud"}${s.publishedAt ? " • " + String(s.publishedAt).slice(0,19) : ""}`;
      const hash = `d=signal-${i}`;

      list.appendChild(
        rowClickable({
          title,
          meta,
          tag: stageLabel(s.stage),
          cls: "signal",
          hash,
          onOpenDetails: ()=>{
            const payload = buildSignalDetails(s);
            openModal({
              ...payload,
              shareUrl: shareUrl(hash),
              shareText: title + " — NetThud"
            });
          }
        })
      );
    });

  }catch(e){
    list.innerHTML="";
    list.appendChild(rowBasic("Transfer signals not loading", e.message, "ERR","warn"));
  }
}

/* ---------------------------
   AI NEWS
--------------------------- */

function slugify(s){
  return String(s||"")
    .toLowerCase()
    .trim()
    .replace(/[^\w\s-]/g,"")
    .replace(/\s+/g,"-")
    .replace(/-+/g,"-")
    .slice(0,60) || ("id-"+Math.random().toString(16).slice(2));
}

function buildFallbackArticle(n){
  const title = n.title || "News";
  const summary = n.summary || "";
  return [
    title,
    "",
    "Context",
    "This item is generated by NetThud AI as a fast brief + a longer read format.",
    "",
    "What happened",
    summary || "No summary provided yet.",
    "",
    "Why it matters",
    "This can influence prep, tactics, availability, and short-term attention around fixtures.",
    "",
    "What to watch next",
    "Look for primary-source confirmation and follow-on signals over the next 24–72 hours.",
    "",
    "Disclaimer",
    "AI-generated summary; may contain errors."
  ].join("\n");
}

async function loadNews(){
  const list = $("newsList");
  try{
    const data = await readJson(PATHS.news);
    const items = Array.isArray(data.items) ? data.items : [];

    safeSetText("newsMeta", `${items.length} • updated ${data.generatedAt||data.updated||data.updatedAt||"—"}`);
    list.innerHTML = "";

    if(!items.length){
      list.appendChild(rowBasic("No AI news yet", "", "—"));
      NEWS_INDEX = [];
      return;
    }

    NEWS_INDEX = items.map((n,i)=>{
      const id = n.id || ("news-"+(i+1));
      const slug = slugify(id);
      const title = n.title || ("News-"+(i+1));
      const source = n.source || "NetThud AI";
      const createdAt = n.createdAt || n.publishedAt || n.date || "";
      const metaLine = [source, createdAt ? String(createdAt).slice(0,19) : ""].filter(Boolean).join(" • ");
      const article = (n.article && String(n.article).trim().length > 60)
        ? String(n.article)
        : buildFallbackArticle({title, summary:n.summary});
      return { slug, title, meta: metaLine, summary: n.summary || n.short || "", article };
    });

    NEWS_INDEX.slice(0,60).forEach((n, i)=>{
      const label = "News-" + (i+1);
      const rowTitle = `${label} • ${n.title}`;
      const rowMeta = n.summary || "Click to open the AI article.";
      const hash = `news=${n.slug}`;

      list.appendChild(
        rowClickable({
          title: rowTitle,
          meta: rowMeta,
          tag: "OPEN",
          cls: "",
          hash,
          onOpenDetails: ()=>{
            const u = shareUrl(hash);
            openModal({
              title: n.title,
              meta: n.meta,
              article: n.article,
              shareUrl: u,
              shareText: n.title + " — NetThud AI"
            });
          }
        })
      );
    });

  }catch(e){
    list.innerHTML="";
    list.appendChild(rowBasic("AI news not loading", e.message, "ERR","warn"));
    safeSetText("newsMeta", "error");
  }
}

/* ---------------------------
   LEAGUES
--------------------------- */
async function loadLeagues(){
  const box = $("leagueChips");
  try{
    const data = await readJson(PATHS.leagues);
    const leagues = Array.isArray(data) ? data
                  : Array.isArray(data.items) ? data.items
                  : Array.isArray(data.leagues) ? data.leagues
                  : [];

    safeSetText("leaguesMeta", `${leagues.length} • updated ${data.updated||data.generatedAt||"—"}`);
    box.innerHTML = "";

    if(!leagues.length){
      box.appendChild(rowBasic("No leagues yet", "/assets/data/leagues.json items[] is empty.", "EMPTY", "warn"));
      return;
    }

    leagues.forEach(l=>{
      const el = document.createElement("div");
      el.className = "chip";
      const name = (l && typeof l === "object") ? (l.name || l.key || "League") : String(l);
      const emoji = (l && typeof l === "object") ? (l.emoji || "") : "";
      const country = (l && typeof l === "object") ? (l.country || "") : "";

      el.innerHTML = `<span class="dot"></span>${esc(emoji ? emoji + " " : "")}${esc(name)}${esc(country ? " • " + country : "")}`;
      box.appendChild(el);
    });

  }catch(e){
    box.innerHTML="";
    box.appendChild(rowBasic("Leagues not loading", e.message, "ERR","warn"));
    safeSetText("leaguesMeta","error");
  }
}

/* ---------------------------
   HASH ROUTING
     #t=tabId
     #news=slug
     #d=kind-index  (live/final/upcoming/signal)
--------------------------- */
function tryOpenFromHash(){
  const h = window.location.hash || "";

  if (h.startsWith("#t=")){
    const tabId = decodeURIComponent(h.slice(3));
    if (tabId) showTab(tabId, { push:false });
    return;
  }

  if (h.startsWith("#news=")){
    const slug = decodeURIComponent(h.slice("#news=".length));
    const found = (NEWS_INDEX || []).find(x => x.slug === slug);
    if (!found) return;
    const u = shareUrl("news=" + found.slug);
    openModal({
      title: found.title,
      meta: found.meta,
      article: found.article,
      shareUrl: u,
      shareText: found.title + " — NetThud AI"
    });
    return;
  }

  if (!h.startsWith("#d=")) return;
  const key = decodeURIComponent(h.slice("#d=".length));
  const [kind, idxStr] = key.split("-");
  const idx = Number(idxStr);
  if (!Number.isFinite(idx) || idx < 0) return;

  let payload = null;
  if (kind === "live" && LIVE_INDEX[idx]) payload = buildMatchDetails("live", LIVE_INDEX[idx]);
  if (kind === "final" && FINAL_INDEX[idx]) payload = buildMatchDetails("final", FINAL_INDEX[idx]);
  if (kind === "upcoming" && UPCOMING_INDEX[idx]) payload = buildMatchDetails("upcoming", UPCOMING_INDEX[idx]);
  if (kind === "signal" && SIGNALS_INDEX[idx]) payload = buildSignalDetails(SIGNALS_INDEX[idx]);

  if (!payload) return;

  const u = shareUrl("d=" + kind + "-" + idx);
  openModal({
    ...payload,
    shareUrl: u,
    shareText: payload.title + " — NetThud"
  });
}

/* ---------------------------
   TABS
--------------------------- */
function showTab(tabId, { push=true } = {}){
  document.querySelectorAll(".tabSection").forEach(s => s.classList.remove("active"));
  document.getElementById(tabId)?.classList.add("active");

  document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
  document.querySelector(`.tabBtn[data-tab="${CSS.escape(tabId)}"]`)?.classList.add("active");

  document.querySelector("main")?.scrollTo({ top: 0, behavior: "smooth" });

  if (push) history.replaceState(null, "", "#t=" + encodeURIComponent(tabId));
}
function wireTabs(){
  document.querySelectorAll(".tabBtn").forEach(btn=>{
    btn.onclick = ()=> showTab(btn.dataset.tab, { push:true });
  });
}

/* ---------------------------
   SOUND TOGGLE
--------------------------- */
const SOUND_KEY = "netthud_sound";
function setSoundUI(on){
  const st = $("soundState");
  if (st) st.textContent = on ? "ON" : "OFF";
}
function getSound(){ return localStorage.getItem(SOUND_KEY) !== "0"; }
function setSound(on){ localStorage.setItem(SOUND_KEY, on ? "1" : "0"); setSoundUI(on); }
function beep(){
  if (!getSound()) return;
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type="sine"; o.frequency.value=440; g.gain.value=0.02;
    o.connect(g); g.connect(ctx.destination);
    o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 80);
  }catch{}
}

/* ---------------------------
   BOOT
--------------------------- */
document.addEventListener("DOMContentLoaded", async ()=>{
  $("year").textContent = new Date().getFullYear();

  wireTabs();

  setSoundUI(getSound());
  $("soundPill")?.addEventListener("click", ()=>{
    const on = !getSound();
    setSound(on);
    beep();
  });

  await loadScores();
  await loadUpcoming();
  await loadTransferSignals();
  await loadNews();
  await loadLeagues();

  if (!location.hash || location.hash === "#"){
    showTab("liveScores", { push:false });
  } else {
    tryOpenFromHash();
  }
  window.addEventListener("hashchange", tryOpenFromHash);
});
</script>

</body>
</html>